---
title: 'Similar Sentences: Locality Sensitive Hashing application'
author: "bdanalytics"
output:
  html_document:
    highlight: tango
---
#### Date: `r format(Sys.time(), "(%a) %b %d, %Y")`

Data:   
Source: 
Time period: 

### Synopsis:

Potential next steps include:

1. Id word_1 & word_n that is freq present in edit_distance > 1

```{r initialize_script}
rm(list=ls())
suppressPackageStartupMessages(require(knitr))
work_dir <- "~/Documents/Work/Courses/Coursera/mining-massive-datasets/Project/similar-sentences" 
setwd(work_dir)
#opts_chunk$set(cache.path="cache/")
opts_chunk$set(autodep=T)
opts_knit$set(output.dir=work_dir)
dep_auto()
#dep_auto(path=opts_chunk$get("cache.path"))
set.seed(12345)
source("~/Dropbox/datascience/R/mydsutils.R")
source("~/Dropbox/datascience/R/myplot.R")
# Gather all package requirements here
suppressPackageStartupMessages(require(plyr))
suppressPackageStartupMessages(require(reshape))

stm <- proc.time()
stm_diff <- proc.time() - stm
script_time_df <- data.frame(chunk="initialize_script", elapsed=stm_diff["elapsed"])
```

### import data
```{r import_data, cache=TRUE}
sentences_df <- myimport_data(
    "https://d396qusza40orc.cloudfront.net/mmds/datasets/sentences.txt.zip", 
    "sentences.txt", nrows=20000, stringsAsFactors=FALSE)
names(sentences_df) <- "raw"

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="import_data", elapsed=stm_diff["elapsed"]))
```

#```{r inspect_data, cache=TRUE, autodep=TRUE}
```{r inspect_data}

# Create new features that help analyses
sentences_df$id <- sapply(sentences_df$raw, 
                          function(raw) as.integer(strsplit(raw, " ")[[1]][1]))
sentences_df$words_lst <- sapply(sentences_df$raw, 
                                 function(raw) { 
                                     lst <- strsplit(raw, " ")[[1]]
                                     list(unlist(lst)[seq.int(2, length(lst))])
                                               })
sentences_df$words_n <- sapply(sentences_df$words_lst, length)
sentences_df$word_1 <- sapply(sentences_df$words_lst, 
                                   function (words_lst) unlist(words_lst)[1])
sentences_df$word_2 <- sapply(sentences_df$words_lst, 
                                   function (words_lst) unlist(words_lst)[2])
sentences_df$word_3 <- sapply(sentences_df$words_lst, 
                                   function (words_lst) unlist(words_lst)[3])
sentences_df$word_4 <- sapply(sentences_df$words_lst, 
                                   function (words_lst) unlist(words_lst)[4])
sentences_df$word_5 <- sapply(sentences_df$words_lst, 
                                   function (words_lst) unlist(words_lst)[5])

sentences_df$word_n_m4 <- sapply(sentences_df$words_lst, 
                                  function (words_lst) unlist(words_lst)[length(words_lst)-4])
sentences_df$word_n_m3 <- sapply(sentences_df$words_lst, 
                                  function (words_lst) unlist(words_lst)[length(words_lst)-3])
sentences_df$word_n_m2 <- sapply(sentences_df$words_lst, 
                                  function (words_lst) unlist(words_lst)[length(words_lst)-2])
sentences_df$word_n_m1 <- sapply(sentences_df$words_lst, 
                                  function (words_lst) unlist(words_lst)[length(words_lst)-1])
sentences_df$word_n <- sapply(sentences_df$words_lst, 
                                  function (words_lst) unlist(words_lst)[length(words_lst)])
print(str(subset(sentences_df, select=-c(words_lst))))

# List info gathered for various columns
# raw:
# id:           int:    record id
# words_lst:    list:   words in this sentence
# words_n:      int:    number of words in this sentence
# word_1   string: first word in sentence
# words_lst     string: last word in sentence

#print(summary(sentences_df))
# generates a very long output
print(summary(subset(sentences_df, select=-c(words_lst))))

sentences_df <- subset(sentences_df, select=-c(raw))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="inspect_data", elapsed=stm_diff["elapsed"]))
```

Sort the sentences by number of words
#```{r hash_words_n, cache=TRUE, autodep=TRUE}
```{r hash_words_n}
sentences_df <- sentences_df[order(sentences_df$words_n, sentences_df$id), ]
#print(head(sentences_df))
print(myplot_histogram(sentences_df, "words_n"))

# create a hash table with begin & end positions of each sentence length
#   to avoid scanning the entire sentence_df for each query
sntnc_lengths_df <- data.frame(words_n=unique(sentences_df$words_n))
sntnc_lengths_df$pos_beg <- 1
sntnc_lengths_df$pos_end <- nrow(sentences_df)
myprint_df(sntnc_lengths_df)
sntnc_lengths_cursor <- 1
for (row_pos in seq(1:nrow(sentences_df))) {
    this_words_n <- sentences_df[row_pos, "words_n"]
    if (sntnc_lengths_df[sntnc_lengths_cursor, "words_n"] < this_words_n) {
        sntnc_lengths_df[sntnc_lengths_cursor, "pos_end"] <- row_pos - 1           
        sntnc_lengths_cursor <- sntnc_lengths_cursor + 1
        if (sntnc_lengths_df[sntnc_lengths_cursor, "words_n"] != this_words_n)
            stop("this should not happen")
        
        sntnc_lengths_df[sntnc_lengths_cursor, "pos_beg"] <- row_pos
        }
    }
myprint_df(sntnc_lengths_df)

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="hash_words_n", elapsed=stm_diff["elapsed"]))
```

Let's try initializing comparison_pairs_df to estimated density
#```{r build_find_pairs_tools, cache=TRUE, autodep=TRUE}
```{r build_find_pairs_tools}
print(nrow(sentences_df))
# Preallocate space for pairs that need to be compared 
comparison_pairs_n_est <- (nrow(sentences_df) ^ 2) * 0.00010 * 1.05
comparison_pairs_df <- data.frame(query_id=rep(-1, comparison_pairs_n_est),
                                  compare_id=rep(-1, comparison_pairs_n_est),
                                  is.common_query_word_1=rep(FALSE, 
                                                             comparison_pairs_n_est))
common_words <- c("000", "2001", "2007", "2008", 
                "a", "abortion", "about", "action", "activities", "after", 
                    "again", "ago", "agora", "ahora", 
                    "alex", "all", "also", "although", 
                    "am", "amazing", "america", "american", 
                    "an", "and", "angeles", 
                    "any", "alaska", "alone", "americans", "answers", "anything",
                    "are", "area", 
                    "around", "as", "at", 
                    "australia", "australian", "away",
                "back", "barack", "be", "because", "been", "before", "believe",
                    "best", 
                    "biggest", "bill", "bills", "bit", 
                    "blog", "both", "britney", "business", "but", "by", 
                "c", "came", "campaign", "can", "care", "casa", "change", "children",
                    "china", 
                    "choice", "city",
                    "climate", 
                    "coach", "cold", "com", "commitment", "companies", 
                        "company", "con", "content", "cool", "costs", "could", 
                        "country", 
                    "crisis", "cruelty", "cuando", "customers", 
                "das", "date", "day", "days", "de", "department", "desde", 
                    "did", "didnt", "direction",
                    "disappointed", "do", "done", "dont", "down", "during",
                "e", "economy", "el", "electoral", "else", "em", "en", "endeavor", 
                    "environment", 
                    "equal", "es", "esta", "estoy", "eternity", 
                    "eu", "even", "events", "every", "everybody", "everyone", 
                    "exciting", "experience", "expertise", 
                "facilities", "fact", "families", "family", "feel", "few", 
                    "first", "fit",
                    "foi", "for", 
                    "formula", "from", 
                    "fuel", "function", "fund", "future", 
                "game", "games", "gas", "given", 
                    "goal", "god", "good", "got", "government", 
                    "grandchildren", "great", "guess", "guy", 
                "had", "happens", "has", "have", "having", "he", "heart", "hell", 
                    "helpful", "her", "here",
                    "hes", "hey", "him", "his", "history", 
                    "home", "hope", "hopefully", "house", "how", "however",
                "i", "id", "idea", "if", "il", "ill", "im", 
                    "in", "industry", "infection", "internet", "interest", 
                        "interests", "internationally", "into", "investment", 
                    "iraq", 
                    "is", "issue", "issues", "it", "its", "ive",
                "jobs", "journalists", "just",
                "kent", "know", 
                "la", "land", "las", "last", "law", "les", "less", "level", 
                    "life", "like", 
                    "lives", "lo",
                    "looked", "looking", "los", "lot", "love", 
                "made", "making", "man", "many", "market", "mas", "matter", 
                    "maybe", "me",
                    "mean", "media", "members", "met", 
                    "mine",
                    "more", "most", "mr", "my", "myself",
                "n", "na", "nation", "need", "never", "new", "next", "night", 
                    "no", "nos", 
                    "not", "now", "nu", 
                "o", "obama", "of", "oh", "on", "one", "online", "only", 
                    "operations", "opponent", "opportunity", "or", 
                    "organization", "os", "others", "our", "out", "outcome", "over", 
                    "overall", "own",
                "para", "parece", "participants", "past", "people", "percent", 
                    "period", "person", "peter", 
                    "place", "plazo", "please", 
                    "poderes", "policy", "politics", "por", "position", 
                    "prices", "problem", "process", "program", "promise", 
                    "public", "purpose",  
                "que", "quickly", 
                "really", "region", "results", "reuters", "ria", "right", 
                    "ruling", "run",
                "s", "said", "saya", "se", "sector", "secure", "see", "selecci",
                    "serious", 
                    "serve", "service",
                    "she", "shes", "should", "si", "side", 
                    "so", "society", "software", "soil", "solution", "some", "son",
                    "spot", 
                    "staff", "state", "stop", "story", "study", "stuff", "success",
                    "sure", "surgery",
                "t", "team", "tempo", "tengo", 
                    "than", "that", "thats", 
                    "the", "them", "themselves", "then", "there", "theres", 
                        "these", "they", "theyre", 
                    "thing", "things", "think", "this", 
                    "those", "though", "thought",  
                    "time", "times", "tinha", "to", "today", "todays", "too", 
                    "treatment", "tried",
                    "two",
                "u", "un", "under", "unless", "up", "us",
                "very", "violence", 
                "wait", "want", "war", "was", "way", "we", "week", "weeks", "well", 
                    "were", "weve", 
                    "what", "when", "whenever", "where", "while", "white", "why",
                    "will", "with",
                    "work", "working", 
                    "world", "words", "would", "wrong", 
                "year", "years", "yet", "yo", "you", "youre")

get_compare_targets <- function (query_sentence_df, sentences_chk_df) {
    row_word_1      <- query_sentence_df$word_1
    row_word_2      <- query_sentence_df$word_2
    row_word_3      <- query_sentence_df$word_3
    row_word_4      <- query_sentence_df$word_4
    row_word_5      <- query_sentence_df$word_5    

    row_word_n_m4   <- query_sentence_df$word_n_m4
    row_word_n_m3   <- query_sentence_df$word_n_m3
    row_word_n_m2   <- query_sentence_df$word_n_m2
    row_word_n_m1   <- query_sentence_df$word_n_m1
    row_word_n      <- query_sentence_df$word_n

    targets_df <- sentences_chk_df[
                        #are.targets_condition
                (
                    # is.same_prefix
                    (
                        if (!(row_word_1 %in% common_words)) { 
                                (sentences_chk_df$word_1 == row_word_1) 
                        } else {       
                        if (!(row_word_2 %in% common_words)) { 
                               ((sentences_chk_df$word_1 == row_word_1) & 
                                (sentences_chk_df$word_2 == row_word_2))
                        } else {       
                        if (!(row_word_3 %in% common_words)) { 
                               ((sentences_chk_df$word_1 == row_word_1) & 
                                (sentences_chk_df$word_2 == row_word_2) &
                                (sentences_chk_df$word_3 == row_word_3))
                        } else {
                        if (!(row_word_4 %in% common_words)) {                             
                               ((sentences_chk_df$word_1 == row_word_1) & 
                                (sentences_chk_df$word_2 == row_word_2) &
                                (sentences_chk_df$word_3 == row_word_3) &
                                (sentences_chk_df$word_4 == row_word_4))
                        } else {                    
                               ((sentences_chk_df$word_1 == row_word_1) & 
                                (sentences_chk_df$word_2 == row_word_2) &
                                (sentences_chk_df$word_3 == row_word_3) &
                                (sentences_chk_df$word_4 == row_word_4) &
                                (sentences_chk_df$word_5 == row_word_5))                            
                        }}}}
                    )
                    |
                    # is.same_suffix
                    (   
                        if (!(row_word_n %in% common_words)) { 
                                (sentences_chk_df$word_n == row_word_n) 
                        } else {
                        if (!(row_word_n_m1 %in% common_words)) {    
                               ((sentences_chk_df$word_n == row_word_n) & 
                                (sentences_chk_df$word_n_m1 == row_word_n_m1))
                        } else {
                        if (!(row_word_n_m2 %in% common_words)) {                            
                               ((sentences_chk_df$word_n == row_word_n) & 
                                (sentences_chk_df$word_n_m1 == row_word_n_m1) &
                                (sentences_chk_df$word_n_m2 == row_word_n_m2))
                        } else {                
                        if (!(row_word_n_m3 %in% common_words)) {                            
                               ((sentences_chk_df$word_n == row_word_n) & 
                                (sentences_chk_df$word_n_m1 == row_word_n_m1) &
                                (sentences_chk_df$word_n_m2 == row_word_n_m2) &
                                (sentences_chk_df$word_n_m3 == row_word_n_m3))
                        } else {
                               ((sentences_chk_df$word_n == row_word_n) & 
                                (sentences_chk_df$word_n_m1 == row_word_n_m1) &
                                (sentences_chk_df$word_n_m2 == row_word_n_m2) &
                                (sentences_chk_df$word_n_m3 == row_word_n_m3) &
                                (sentences_chk_df$word_n_m4 == row_word_n_m4))
                        }}}}    
                    )    
                )             
                        , c("id", "words_n")]
    return(targets_df)
}

#                 sentences_chk_df[
#                         #are.targets_condition
#                     (
#                         # is.same_prefix
#                         FALSE
#                         |
#                         # is.same_suffix     
#                         (sentences_chk_df$word_n == row_word_n)
#                     )             
#                         , c("id", "words_n")]

#                 sentences_chk_df[
#                         #are.targets_condition
#                         (
#                         # is.same_prefix   
#                         (if(!(row_word_1 %in% common_words)) {
#                                 (sentences_chk_df$word_1 == row_word_1)
#                          } else { NULL } )  
#                         |
# #                         FALSE
#                         # is.same_suffix     
#                         (sentences_chk_df$word_n == row_word_n)
#                         )             
#                         , c("id", "words_n")]

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="build_find_pairs_tools", 
                                   elapsed=stm_diff["elapsed"]))
```

Find potential pairs with edit distance at most 1 to be compared. 
This implies that for any query sentence, we need only compare that with sentences that have +/- 1 words length 
#```{r find_pairs_old, cache=TRUE, autodep=TRUE}
```{r find_pairs_old}
loop_step_id_set <- c(  "1_Identified_Query"
                      , "2_Filtered_Length"
                      , "3_Filtered_Dups"
                      , "4_Filtered_FirstLast"
                      , "5_Appended_DFrame"
                     )
loop_df <- data.frame(loop_step_id=loop_step_id_set)
loop_df[, names(summary(proc.time()))] <- 
    rep(0, length(names(summary(proc.time()))) * nrow(loop_df)) 

#for (loop_step_id in loop_df$loop_step_id) {
for (loop_step_id in loop_df$loop_step_id[2:5]) {   
    ltm <- proc.time()
    ltm_diff <- proc.time() - ltm

    comparison_pairs_urow <- 0
    for (row_pos in seq(1:nrow(sentences_df))) {    
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[1])) {
            row_words_n <- sentences_df[row_pos, "words_n"]
            row_word_1 <- sentences_df[row_pos, "word_1"]            
            row_id <- sentences_df[row_pos, "id"]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[2])) {
            sntnc_lengths_row_pos <- 
                which(sntnc_lengths_df$words_n == row_words_n)
            
            if (sntnc_lengths_row_pos != 1) { 
                pos_beg <- sntnc_lengths_df[sntnc_lengths_row_pos - 1, "pos_beg"]
            } else pos_beg <- 1
            
            if (sntnc_lengths_row_pos != nrow(sntnc_lengths_df)) {
                pos_end <- sntnc_lengths_df[sntnc_lengths_row_pos + 1, "pos_end"]
            } else pos_end <- nrow(sentences_df)
                
            sentences_chk_df <- sentences_df[pos_beg:pos_end ,] 
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[3])) {
             # avoid dups in candidate pairs       
            sentences_chk_df <- subset(sentences_chk_df,
                                       #(sentences_chk_df$id != row_id) &
                                       (id < row_id) # to avoid dups       
                                      )            
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[4])) {
            sentences_compare_df <- get_compare_targets(sentences_df[row_pos, ], 
                                                        sentences_chk_df)                
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[5])) { 
            newpairs_n <- nrow(sentences_compare_df)
            if (newpairs_n > 0) {            
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "query_id"] <- 
                   rep(row_id, newpairs_n)
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "compare_id"] <- sentences_compare_df$id
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "is.common_query_word_1"] <- 
                   rep(ifelse(row_word_1 %in% common_words,
                              TRUE, FALSE), newpairs_n)
               

                # this approach takes longer probably due to the collecting on
                #   the rhs
#                 comparison_pairs_df[(comparison_pairs_urow + 1):
#                                     (comparison_pairs_urow + newpairs_n),
#                                     c("query_id", "compare_id")] <- 
#                     c(rep(row_id, newpairs_n), sentences_compare_df$id)

                comparison_pairs_urow <- comparison_pairs_urow + newpairs_n
            }    
        }
    }
    comparison_pairs_df <- subset(comparison_pairs_df, query_id > -1)
    ltm_diff <- proc.time() - ltm
    loop_df[loop_df$loop_step_id == loop_step_id, 
                       names(summary(ltm_diff))] <- summary(ltm_diff)
}
loop_steps_plot_df <- melt(loop_df, id="loop_step_id", 
                           measure=c("user", "system", "elapsed"))
p <- ggplot(data=loop_steps_plot_df, mapping=aes(x=loop_step_id, y=value)) + 
        geom_line(aes(group=variable, color=variable)) 
print(p)

loop_df$user_diff <- sapply(seq(1, nrow(loop_df)), 
                            function(step) ifelse(step <= 1, NA,
                            loop_df[step, "user"] - loop_df[step - 1, "user"]))
print(loop_df)

comparison_pairs_df <- subset(comparison_pairs_df, query_id > -1)
comparison_pairs_df <- orderBy(~ query_id + compare_id, 
                               data=comparison_pairs_df)

print(sprintf("Pairs to be checked: %s", 
              format(nrow(comparison_pairs_df), big.mark=',')))
print(sprintf("Comparison density: %0.4f", 
              nrow(comparison_pairs_df) / (nrow(sentences_df) ^ 2)))
myprint_df(comparison_pairs_df)

### check which query_id generates the most comparison pairs
comparison_pairs_query_id_freq_df <- 
    summaryBy(query_id ~ query_id, data=comparison_pairs_df, FUN=length)
names(comparison_pairs_query_id_freq_df)[2] <- "query_id_freq"
print(myplot_histogram(comparison_pairs_query_id_freq_df, "query_id_freq"))

max_freq_query_id <- subset(comparison_pairs_query_id_freq_df, 
        query_id_freq == max(comparison_pairs_query_id_freq_df$query_id_freq))$query_id
myprint_df(subset(comparison_pairs_df, query_id == max_freq_query_id), dims=TRUE)
myprint_df(subset(sentences_df, id == max_freq_query_id))

# comparison_pairs_old_df <- comparison_pairs_df
# comparison_pairs_old_df <- orderBy(~ query_id + compare_id, 
#                                data=comparison_pairs_old_df)

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="find_pairs_old", 
                                   elapsed=stm_diff["elapsed"]))
```

```{r find_pairs}
loop_step_id_set <- c(  "1_Identified_Query"
                      , "2_Filtered_Length"
                      , "3_Filtered_Dups"
                      , "4_Filtered_FirstLast"
                      , "5_Appended_DFrame"
                     )
loop_df <- data.frame(loop_step_id=loop_step_id_set)
loop_df[, names(summary(proc.time()))] <- 
    rep(0, length(names(summary(proc.time()))) * nrow(loop_df)) 

#for (loop_step_id in loop_df$loop_step_id) {
for (loop_step_id in loop_df$loop_step_id[2:5]) {   
    ltm <- proc.time()
    ltm_diff <- proc.time() - ltm

    comparison_pairs_urow <- 0
    for (row_pos in seq(1:nrow(sentences_df))) {    
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[1])) {
            row_words_n <- sentences_df[row_pos, "words_n"]
            row_word_1 <- sentences_df[row_pos, "word_1"]            
            row_id <- sentences_df[row_pos, "id"]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[2])) {
            sntnc_lengths_row_pos <- 
                which(sntnc_lengths_df$words_n == row_words_n)
            
            if (sntnc_lengths_row_pos != 1) { 
                pos_beg <- sntnc_lengths_df[sntnc_lengths_row_pos - 1, "pos_beg"]
            } else pos_beg <- 1
            
            if (sntnc_lengths_row_pos != nrow(sntnc_lengths_df)) {
                pos_end <- sntnc_lengths_df[sntnc_lengths_row_pos + 1, "pos_end"]
            } else pos_end <- nrow(sentences_df)
                
            sentences_chk_df <- sentences_df[pos_beg:pos_end ,] 
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[3])) {
            sentences_chk_df <- sentences_chk_df[sentences_chk_df$id < row_id, ]            
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[4])) {
            sentences_compare_df <- get_compare_targets(sentences_df[row_pos, ], 
                                                        sentences_chk_df)                
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[5])) { 
            newpairs_n <- nrow(sentences_compare_df)
            if (newpairs_n > 0) {            
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "query_id"] <- 
                   rep(row_id, newpairs_n)
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "compare_id"] <- sentences_compare_df$id
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "is.common_query_word_1"] <- 
                   rep(ifelse(row_word_1 %in% common_words,
                              TRUE, FALSE), newpairs_n)
               

                # this approach takes longer probably due to the collecting on
                #   the rhs
#                 comparison_pairs_df[(comparison_pairs_urow + 1):
#                                     (comparison_pairs_urow + newpairs_n),
#                                     c("query_id", "compare_id")] <- 
#                     c(rep(row_id, newpairs_n), sentences_compare_df$id)

                comparison_pairs_urow <- comparison_pairs_urow + newpairs_n
            }    
        }
    }
    comparison_pairs_df <- subset(comparison_pairs_df, query_id > -1)
    ltm_diff <- proc.time() - ltm
    loop_df[loop_df$loop_step_id == loop_step_id, 
                       names(summary(ltm_diff))] <- summary(ltm_diff)
}
loop_steps_plot_df <- melt(loop_df, id="loop_step_id", 
                           measure=c("user", "system", "elapsed"))
p <- ggplot(data=loop_steps_plot_df, mapping=aes(x=loop_step_id, y=value)) + 
        geom_line(aes(group=variable, color=variable)) 
print(p)

loop_df$user_diff <- sapply(seq(1, nrow(loop_df)), 
                            function(step) ifelse(step <= 1, NA,
                            loop_df[step, "user"] - loop_df[step - 1, "user"]))
print(loop_df)

comparison_pairs_df <- subset(comparison_pairs_df, query_id > -1)
comparison_pairs_df <- orderBy(~ query_id + compare_id, 
                               data=comparison_pairs_df)

print(sprintf("Pairs to be checked: %s", 
              format(nrow(comparison_pairs_df), big.mark=',')))
print(sprintf("Comparison density: %0.4f", 
              nrow(comparison_pairs_df) / (nrow(sentences_df) ^ 2)))
myprint_df(comparison_pairs_df)

### check which query_id generates the most comparison pairs
comparison_pairs_query_id_freq_df <- 
    summaryBy(query_id ~ query_id, data=comparison_pairs_df, FUN=length)
names(comparison_pairs_query_id_freq_df)[2] <- "query_id_freq"
print(myplot_histogram(comparison_pairs_query_id_freq_df, "query_id_freq"))

max_freq_query_id <- subset(comparison_pairs_query_id_freq_df, 
        query_id_freq == max(comparison_pairs_query_id_freq_df$query_id_freq))$query_id
myprint_df(subset(comparison_pairs_df, query_id == max_freq_query_id), dims=TRUE)
myprint_df(subset(sentences_df, id == max_freq_query_id))

# print_old_new_comparison_pairs <- function(this_id) {
#     print("old:")
#     myprint_df(subset(comparison_pairs_old_df, query_id == this_id), dims=TRUE)
#     print("new:")    
#     myprint_df(subset(comparison_pairs_df, query_id == this_id), dims=TRUE)
# }
# 
# print(sprintf("# old comparison pairs: %s", format(nrow(comparison_pairs_old_df), big.mark=",")))
# print(sprintf("# comparison pairs: %s", format(nrow(comparison_pairs_df), big.mark=",")))
# intersect(names(comparison_pairs_old_df), names(comparison_pairs_df))
# comparison_pairs_tmp_df <- 
#     merge(cbind(comparison_pairs_df,     data.frame(new=rep(1, nrow(comparison_pairs_df)))), 
#           cbind(comparison_pairs_old_df, data.frame(old=rep(1, nrow(comparison_pairs_old_df)))),
#           by=c("query_id", "compare_id"), all.x = TRUE, suffixes=c(".new", ".old"))
# comparison_pairs_tmp_df <- orderBy(~ query_id + compare_id, 
#                                     data=comparison_pairs_tmp_df)
# print(all.equal(comparison_pairs_tmp_df[, c("query_id", "compare_id")], 
#                 comparison_pairs_df    [, c("query_id", "compare_id")]))
# # if (!isTRUE(all.equal(comparison_pairs_tmp_df[, 1:(ncol(comparison_pairs_tmp_df) - 2)], 
# #                 comparison_pairs_df))) {
#     print("new not in old comparison pairs:")
#     print(subset(comparison_pairs_tmp_df, is.na(old)))
#     #print(subset(comparison_pairs_tmp_df, new != old))
# # }
# # print_old_new_comparison_pairs(4986)
# # print(sentences_df[sentences_df$id == 77, "words_lst"])
# # print(sentences_df[sentences_df$id == 75, "words_lst"])

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="find_pairs", 
                                   elapsed=stm_diff["elapsed"]))
```

#```{r build_comparison_tools, cache=TRUE, autodep=TRUE}
```{r build_comparison_tools}

# create a reverse index table of sentences_df to fast index into sentences_df 
#   given a sentences_df$id 
sntnc_pos_df <- data.frame(pos=rep(-1, max(sentences_df$id)),
                           id=seq(1, max(sentences_df$id)))
for (row_pos in seq(1:nrow(sentences_df))) {
    sntnc_pos_df[sentences_df[row_pos, "id"], "pos"] <- row_pos
}
myprint_df(sntnc_pos_df)

func_step_id_set <- c(  "1_unlist"
                      , "2_union"
                      , "3_intersection"
                      , "4_distance"
                     )
func_df <- data.frame(func_step_id=func_step_id_set)

sentence_edit_distance <- function(words_lst1, words_lst2) {
#     words1 <- sort(unlist(words_lst1))
#     words2 <- sort(unlist(words_lst2))
    
#     ftm <- proc.time()
    words1 <- unlist(words_lst1)
    words2 <- unlist(words_lst2)
#     ftm_diff <- proc.time() - ftm; 
#     func_df[1, names(summary(ftm_diff))] <<- func_df[1, names(summary(ftm_diff))] + 
#         summary(ftm_diff)

#     ftm <- proc.time()
    union12 <- union(words1, words2)
#     ftm_diff <- proc.time() - ftm; 
#     func_df[2, names(summary(ftm_diff))] <<- func_df[2, names(summary(ftm_diff))] + 
#         summary(ftm_diff)

#     ftm <- proc.time()    
    intersect12 <- intersect(words1, words2)
#     ftm_diff <- proc.time() - ftm; 
#     func_df[3, names(summary(ftm_diff))] <<- func_df[3, names(summary(ftm_diff))] + 
#         summary(ftm_diff)

#     ftm <- proc.time()    
    distance <- length(union12) - length(intersect12)
    # account for substitutions
    if ((distance == 2) & (length(words1) == length(words2)))
        distance <- 1
    
#     ftm_diff <- proc.time() - ftm; 
#     func_df[4, names(summary(ftm_diff))] <<- func_df[4, names(summary(ftm_diff))] + 
#         summary(ftm_diff)

    return(distance)
}

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="build_comparison_tools", 
                                   elapsed=stm_diff["elapsed"]))
```

#```{r compare_pairs_old, cache=TRUE, autodep=TRUE}
```{r compare_pairs_old}

#comparison_pairs_old_df <- comparison_pairs_df

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="compare_pairs_old", 
                                   elapsed=stm_diff["elapsed"]))
```

#```{r compare_pairs, cache=TRUE, autodep=TRUE}
```{r compare_pairs}
loop_step_id_set <- c(  "1_comparison_pairs_df_access"
                      , "2_sentences_df_access"
                      , "3_update_edit_distance"
                     )
loop_df <- data.frame(loop_step_id=loop_step_id_set)
loop_df[, names(summary(proc.time()))] <- 
    rep(0, length(names(summary(proc.time()))) * nrow(loop_df)) 

#for (loop_step_id in loop_df$loop_step_id) {
for (loop_step_id in loop_df[nrow(loop_df), "loop_step_id"]) {   
    ltm <- proc.time()
    ltm_diff <- proc.time() - ltm
    
    func_df[, names(summary(proc.time()))] <- 
        rep(0, length(names(summary(proc.time()))) * nrow(func_df)) 

    for (row in seq(1, nrow(comparison_pairs_df))) {
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[1])) {
            row_id1 <- comparison_pairs_df[row, "query_id"]
            row_id2 <- comparison_pairs_df[row, "compare_id"]
        }
                
        if (toString(loop_step_id) >= toString(loop_step_id_set[2])) {
            row_words_lst1 <- sentences_df[sntnc_pos_df[row_id1, "pos"], "words_lst"]
            row_words_lst2 <- sentences_df[sntnc_pos_df[row_id2, "pos"], "words_lst"]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[3])) {
            comparison_pairs_df[row, "edit_distance"] <- 
                sentence_edit_distance(row_words_lst1, row_words_lst2)
        }
    }
    
    ltm_diff <- proc.time() - ltm
    loop_df[loop_df$loop_step_id == loop_step_id, 
                       names(summary(ltm_diff))] <- summary(ltm_diff)
}
loop_steps_plot_df <- melt(loop_df, id="loop_step_id", 
                           measure=c("user", "system", "elapsed"))
p <- ggplot(data=loop_steps_plot_df, mapping=aes(x=loop_step_id, y=value)) + 
        geom_line(aes(group=variable, color=variable)) 
print(p)
loop_df$user_diff <- sapply(seq(1, nrow(loop_df)), 
                            function(step) ifelse(step <= 1, 0,
                            loop_df[step, "user"] - loop_df[step - 1, "user"]))
print(loop_df)

# func_plot_df <- melt(func_df, id="func_step_id", 
#                            measure=c("user", "system", "elapsed"))
# p <- ggplot(data=func_plot_df, mapping=aes(x=func_step_id, y=value)) + 
#         geom_line(aes(group=variable, color=variable)) 
p <- ggplot(data=func_df, mapping=aes(x=func_step_id, y=elapsed)) + 
        geom_bar(stat="identity") 
print(p)
print(func_df)

# print(all.equal(comparison_pairs_df, 
#                  comparison_pairs_old_df))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="compare_pairs", 
                                   elapsed=stm_diff["elapsed"]))
```

#```{r inspect_results, cache=TRUE, autodep=TRUE}
```{r inspect_results}
### routine checks
zero_edit_distance_row <- 
    comparison_pairs_df[which(comparison_pairs_df$edit_distance == 
                              0)[1], ]
print(zero_edit_distance_row)
print(paste0("edit_distance==0: ", toString(zero_edit_distance_row)))
if (!is.na(zero_edit_distance_row$query_id)) {
    print(sentences_df[sentences_df$id == zero_edit_distance_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == zero_edit_distance_row$compare_id, "words_lst"])
}

one_edit_distance_rows <- 
    comparison_pairs_df[which(comparison_pairs_df$edit_distance == 
                              1), ]
one_edit_distance_rows <- merge(one_edit_distance_rows, 
                                sentences_df[, c("id", "words_n")], 
                                by.x="query_id", by.y="id")
names(one_edit_distance_rows)[5] <- "query_words_n"
one_edit_distance_rows <- merge(one_edit_distance_rows, 
                                sentences_df[, c("id", "words_n")], 
                                by.x="compare_id", by.y="id")
names(one_edit_distance_rows)[6] <- "compare_words_n"
one_edit_distance_ad_row <- subset(one_edit_distance_rows, 
                                   query_words_n != compare_words_n)[1, ]
print(paste0("edit_distance==1(A/D): ", toString(one_edit_distance_ad_row)))
if (!is.na(one_edit_distance_ad_row$query_id)) {
    print(sentences_df[sentences_df$id == one_edit_distance_ad_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == one_edit_distance_ad_row$compare_id, "words_lst"])
    query_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_ad_row$query_id, 
                            "words_lst"])
    compare_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_ad_row$compare_id, 
                            "words_lst"])
    print(setdiff(union(query_words_lst, compare_words_lst), 
                  intersect(query_words_lst, compare_words_lst)))
}

one_edit_distance_md_row <- subset(one_edit_distance_rows, 
                                   query_words_n == compare_words_n)[1, ]
print(paste0("edit_distance==1(Mod): ", toString(one_edit_distance_md_row)))
if (!is.na(one_edit_distance_md_row$query_id)) {
    print(sentences_df[sentences_df$id == one_edit_distance_md_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == one_edit_distance_md_row$compare_id, "words_lst"])
    query_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_md_row$query_id, 
                            "words_lst"])
    compare_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_md_row$compare_id, 
                            "words_lst"])
    print(setdiff(union(query_words_lst, compare_words_lst), 
                  intersect(query_words_lst, compare_words_lst)))
}
### pair check (query_id=4593, compare_id=1748)
###     debug code
# print(dim(comparison_pairs_old_df))
# print(dim(comparison_pairs_df))
# print(subset(comparison_pairs_old_df, query_id == 4593))
# print(subset(comparison_pairs_df, query_id == 4593))

two_edit_distance_row <- 
    comparison_pairs_df[which(comparison_pairs_df$edit_distance == 
                              2)[1], ]
print(paste0("edit_distance==2: ", toString(two_edit_distance_row)))
if (!is.na(two_edit_distance_row$query_id)) {
    print(sentences_df[sentences_df$id == two_edit_distance_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == two_edit_distance_row$compare_id, "words_lst"])
    query_words_lst <- 
        unlist(sentences_df[sentences_df$id == two_edit_distance_row$query_id, 
                            "words_lst"])
    compare_words_lst <- 
        unlist(sentences_df[sentences_df$id == two_edit_distance_row$compare_id, 
                            "words_lst"])
    print(setdiff(union(query_words_lst, compare_words_lst), 
                  intersect(query_words_lst, compare_words_lst)))
}

print(myplot_histogram(subset(comparison_pairs_df, edit_distance > 1), 
                       "edit_distance"))
### check which pair generates the highest distance
print("max edit_distance:")
comparison_pairs_srtd_df <- orderBy(~ - edit_distance + query_id + compare_id, 
                                    comparison_pairs_df)
for (row in 1:10) {
    print(comparison_pairs_srtd_df[row, ])
    print(sentences_df[sentences_df$id == comparison_pairs_srtd_df$query_id[row],
                       "words_lst"])
    print(sentences_df[sentences_df$id == comparison_pairs_srtd_df$compare_id[row],
                       "words_lst"])
}

print(sprintf("Script Summary:"))
print(sprintf("Number of sentences read: %s", 
              format(nrow(sentences_df), big.mark=',')))
print(sprintf("Number of comparison pairs: %s", 
              format(nrow(comparison_pairs_df), big.mark=',')))
print(sprintf("Comparison density: %0.5f", 
              nrow(comparison_pairs_df) / (nrow(sentences_df) ^ 2)))
print(sprintf("Number of sentence pairs within edit distance of 1: %s",
              format(sum(comparison_pairs_df$edit_distance <= 1), big.mark=',')))
print(sprintf("Similarity-Comparison density: %0.4f", 
              nrow(subset(comparison_pairs_df, edit_distance <= 1)) / 
                  nrow(comparison_pairs_df)))
print(sprintf("Similarity-Comparison density of max_freq_query_id: %0.4f", 
              nrow(subset(comparison_pairs_df, 
                          (edit_distance <= 1) & (query_id == max_freq_query_id))) / 
                  nrow(subset(comparison_pairs_df, 
                              query_id == max_freq_query_id))))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="inspect_results", 
                                   elapsed=stm_diff["elapsed"]))
```

```{r print_sessionInfo, echo=FALSE}
rownames(script_time_df) <- seq(1, nrow(script_time_df))
script_time_df$elapsed_diff <- sapply(seq(1, nrow(script_time_df)), 
                                      function(step) ifelse(step <= 1, 0,
        script_time_df[step, "elapsed"] - script_time_df[step - 1, "elapsed"]))
print(script_time_df[order(script_time_df$elapsed_diff, decreasing=TRUE),])
print(sprintf("Total Elapsed Time: %s secs", 
              format(script_time_df[nrow(script_time_df), "elapsed"], big.mark=',')))
sessionInfo()
```