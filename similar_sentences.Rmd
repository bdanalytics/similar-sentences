---
title: 'Similar Sentences: Locality Sensitive Hashing application'
author: "bdanalytics"
output:
  html_document:
    highlight: tango
---
#### Date: `r format(Sys.time(), "(%a) %b %d, %Y")`

Data:   
Source: 
Time period: 

### Synopsis:

Potential next steps include:

```{r initialize_script}
rm(list=ls())
suppressPackageStartupMessages(require(knitr))
work_dir <- "~/Documents/Work/Courses/Coursera/mining-massive-datasets/Project/similar-sentences" 
setwd(work_dir)
#opts_chunk$set(cache.path="cache/")
opts_chunk$set(autodep=T)
#opts_knit$set(output.dir=work_dir)
dep_auto()
#dep_auto(path=opts_chunk$get("cache.path"))
set.seed(12345)
source("~/Dropbox/datascience/R/mydsutils.R")
source("~/Dropbox/datascience/R/myplot.R")
# Gather all package requirements here
suppressPackageStartupMessages(require(plyr))
suppressPackageStartupMessages(require(reshape))

stm <- proc.time()
stm_diff <- proc.time() - stm
script_time_df <- data.frame(chunk="initialize_script", elapsed=stm_diff["elapsed"])
```

### import data
```{r import_data, cache=TRUE}
sentences_df <- myimport_data(
    "https://d396qusza40orc.cloudfront.net/mmds/datasets/sentences.txt.zip", 
    "sentences.txt", nrows=4000, stringsAsFactors=FALSE)
names(sentences_df) <- "raw"

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="import_data", elapsed=stm_diff["elapsed"]))
```

#```{r inspect_data, cache=TRUE, autodep=TRUE}
```{r inspect_data}

# Create new features that help analyses
sentences_df$id <- sapply(sentences_df$raw, 
                          function(raw) as.integer(strsplit(raw, " ")[[1]][1]))
sentences_df$words_lst <- sapply(sentences_df$raw, 
                                 function(raw) { 
                                     lst <- strsplit(raw, " ")[[1]]
                                     list(unlist(lst)[seq.int(2, length(lst))])
                                               })
sentences_df$words_n <- sapply(sentences_df$words_lst, length)
sentences_df$words_first <- sapply(sentences_df$words_lst, 
                                   function (words_lst) unlist(words_lst)[1])
sentences_df$words_last <- sapply(sentences_df$words_lst, 
                                  function (words_lst) unlist(words_lst)[length(words_lst)])
print(str(subset(sentences_df, select=-c(words_lst))))

# List info gathered for various columns
# raw:
# id:           int:    record id
# words_lst:    list:   words in this sentence
# words_n:      int:    number of words in this sentence
# words_first   string: first word in sentence
# words_lst     string: last word in sentence

#print(summary(sentences_df))
# generates a very long output
print(summary(subset(sentences_df, select=-c(words_lst))))

sentences_df <- subset(sentences_df, select=-c(raw))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="inspect_data", elapsed=stm_diff["elapsed"]))
```

Sort the sentences by number of words
#```{r hash_words_n, cache=TRUE, autodep=TRUE}
```{r hash_words_n}
sentences_df <- sentences_df[order(sentences_df$words_n), ]
#print(head(sentences_df))
print(myplot_histogram(sentences_df, "words_n"))

# create a hash table with begin & end positions of each sentence length
#   to avoid scanning the entire sentence_df for each query
sntnc_lengths_df <- data.frame(words_n=unique(sentences_df$words_n))
sntnc_lengths_df$pos_beg <- 1
sntnc_lengths_df$pos_end <- nrow(sentences_df)
myprint_df(sntnc_lengths_df)
sntnc_lengths_cursor <- 1
for (row_pos in seq(1:nrow(sentences_df))) {
    this_words_n <- sentences_df[row_pos, "words_n"]
    if (sntnc_lengths_df[sntnc_lengths_cursor, "words_n"] < this_words_n) {
        sntnc_lengths_df[sntnc_lengths_cursor, "pos_end"] <- row_pos - 1           
        sntnc_lengths_cursor <- sntnc_lengths_cursor + 1
        if (sntnc_lengths_df[sntnc_lengths_cursor, "words_n"] != this_words_n)
            stop("this should not happen")
        
        sntnc_lengths_df[sntnc_lengths_cursor, "pos_beg"] <- row_pos
        }
    }
myprint_df(sntnc_lengths_df)

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="hash_words_n", elapsed=stm_diff["elapsed"]))
```

Find potential pairs with edit distance at most 1 to be compared. 
This implies that for any query sentence, we need only compare that with sentences that have +/- 1 words length 
```{r find_compare_pairs_old, cache=TRUE, autodep=TRUE}
#```{r find_compare_pairs_old}

#comparison_pairs_old_df <- comparison_pairs_df

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="find_compare_pairs_old", 
                                   elapsed=stm_diff["elapsed"]))
```

Let's try initializing comparison_pairs_df to estimated density
#```{r find_compare_pairs, cache=TRUE, autodep=TRUE}
```{r find_compare_pairs}
print(nrow(sentences_df))
# Preallocate space for pairs that need to be compared 
comparison_pairs_n_est <- (nrow(sentences_df) ^ 2) * 0.0012 * 1.05
comparison_pairs_df <- data.frame(query_id=rep(-1, comparison_pairs_n_est),
                                  compare_id=rep(-1, comparison_pairs_n_est))

loop_step_id_set <- c(  "1_Identified_Query"
                      , "2_Filtered_Length"
                      , "3_Filtered_Dups"
                      , "4_Filtered_FirstLast"
                      , "5_Appended_DFrame"
                     )
loop_df <- data.frame(loop_step_id=loop_step_id_set)
loop_df[, names(summary(proc.time()))] <- 
    rep(0, length(names(summary(proc.time()))) * nrow(loop_df)) 

#for (loop_step_id in loop_df$loop_step_id) {
for (loop_step_id in loop_df$loop_step_id[5:5]) {   
    ptm <- proc.time()
    ptm_diff <- proc.time() - ptm

    comparison_pairs_urow <- 0
    for (row_pos in seq(1:nrow(sentences_df))) {    
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[1])) {
            row_words_n <- sentences_df[row_pos, "words_n"]
            row_id <- sentences_df[row_pos, "id"]
            row_words_first <- sentences_df[row_pos, "words_first"]
            row_words_last <- sentences_df[row_pos, "words_last"]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[2])) {
            sntnc_lengths_row_pos <- 
                which(sntnc_lengths_df$words_n == row_words_n)
            
            if (sntnc_lengths_row_pos != 1) { 
                pos_beg <- sntnc_lengths_df[sntnc_lengths_row_pos - 1, "pos_beg"]
            } else pos_beg <- 1
            
            if (sntnc_lengths_row_pos != nrow(sntnc_lengths_df)) {
                pos_end <- sntnc_lengths_df[sntnc_lengths_row_pos + 1, "pos_end"]
            } else pos_end <- nrow(sentences_df)
                
            sentences_chk_df <- sentences_df[pos_beg:pos_end ,] 
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[3])) {        
            sentences_chk_df <- subset(sentences_chk_df,
                                       (sentences_chk_df$id != row_id) &
                                       (sentences_chk_df$id < row_id) # to avoid dups       
                                      )
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[4])) {        
            sentences_compare_df <- sentences_chk_df[ 
                                ((sentences_chk_df$words_first == row_words_first) | 
                                 (sentences_chk_df$words_last == row_words_last)
                                )
                                                     , c("id", "words_n")]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[5])) { 
            newpairs_n <- nrow(sentences_compare_df)
            if (newpairs_n > 0) {            
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "query_id"] <- 
                   rep(row_id, newpairs_n)
               comparison_pairs_df[(comparison_pairs_urow + 1):
                                   (comparison_pairs_urow + newpairs_n),
                                   "compare_id"] <- sentences_compare_df$id

                # this approach takes longer probably due to the collecting on
                #   the rhs
#                 comparison_pairs_df[(comparison_pairs_urow + 1):
#                                     (comparison_pairs_urow + newpairs_n),
#                                     c("query_id", "compare_id")] <- 
#                     c(rep(row_id, newpairs_n), sentences_compare_df$id)

                comparison_pairs_urow <- comparison_pairs_urow + newpairs_n
            }    
        }
    }
    comparison_pairs_df <- subset(comparison_pairs_df, query_id > -1)
    ptm_diff <- proc.time() - ptm
    loop_df[loop_df$loop_step_id == loop_step_id, 
                       names(summary(ptm_diff))] <- summary(ptm_diff)
}
comparison_pairs_df <- subset(comparison_pairs_df, query_id > -1)

loop_steps_plot_df <- melt(loop_df, id="loop_step_id", 
                           measure=c("user", "system", "elapsed"))
p <- ggplot(data=loop_steps_plot_df, mapping=aes(x=loop_step_id, y=value)) + 
        geom_line(aes(group=variable, color=variable)) 
print(p)

loop_df$user_diff <- sapply(seq(1, nrow(loop_df)), 
                            function(step) ifelse(step <= 1, NA,
                            loop_df[step, "user"] - loop_df[step - 1, "user"]))
print(loop_df)

print(sprintf("Pairs to be checked: %s", 
              format(nrow(comparison_pairs_df), big.mark=',')))
print(sprintf("Comparison density: %0.4f", 
              nrow(comparison_pairs_df) / (nrow(sentences_df) ^ 2)))
myprint_df(comparison_pairs_df)

#print(all.equal(comparison_pairs_df, 
#                comparison_pairs_old_df))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="find_compare_pairs", 
                                   elapsed=stm_diff["elapsed"]))
```


```{r compare_pairs_old, cache=TRUE, autodep=TRUE}
#```{r compare_pairs_old}
sentence_edit_distance <- function(words_lst1, words_lst2) {
#     words1 <- sort(unlist(words_lst1))
#     words2 <- sort(unlist(words_lst2))
    words1 <- unlist(words_lst1)
    words2 <- unlist(words_lst2)

    distance <- length(union(words1, words2)) - length(intersect(words1, words2))
    # account for substitutions
    if ((distance == 2) & (length(words1) == length(words2)))
        distance <- 1
    return(distance)
}

loop_step_id_set <- c(  "1_comparison_pairs_df_access"
                      , "2_sentences_df_access"
                      , "3_update_edit_distance"
                     )
loop_df <- data.frame(loop_step_id=loop_step_id_set)
loop_df[, names(summary(proc.time()))] <- 
    rep(0, length(names(summary(proc.time()))) * nrow(loop_df)) 

for (loop_step_id in loop_df$loop_step_id) {
#for (loop_step_id in loop_df[nrow(loop_df), "loop_step_id"]) {   
    ptm <- proc.time()
    ptm_diff <- proc.time() - ptm
    
    for (row in seq(1, nrow(comparison_pairs_df))) {
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[1])) {
            row_id1 <- comparison_pairs_df[row, "query_id"]
            row_id2 <- comparison_pairs_df[row, "compare_id"]
        }
                
        if (toString(loop_step_id) >= toString(loop_step_id_set[2])) {
            row_words_lst1 <- sentences_df[sentences_df$id == row_id1, "words_lst"]
            row_words_lst2 <- sentences_df[sentences_df$id == row_id2, "words_lst"]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[3])) {
            comparison_pairs_df[row, "edit_distance"] <- 
                sentence_edit_distance(row_words_lst1, row_words_lst2)
        }
    }
    
    ptm_diff <- proc.time() - ptm
    loop_df[loop_df$loop_step_id == loop_step_id, 
                       names(summary(ptm_diff))] <- summary(ptm_diff)
}
loop_steps_plot_df <- melt(loop_df, id="loop_step_id", 
                           measure=c("user", "system", "elapsed"))
p <- ggplot(data=loop_steps_plot_df, mapping=aes(x=loop_step_id, y=value)) + 
        geom_line(aes(group=variable, color=variable)) 
print(p)
loop_df$user_diff <- sapply(seq(1, nrow(loop_df)), 
                            function(step) ifelse(step <= 1, 0,
                            loop_df[step, "user"] - loop_df[step - 1, "user"]))
print(loop_df)

comparison_pairs_old_df <- comparison_pairs_df

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="compare_pairs_old", 
                                   elapsed=stm_diff["elapsed"]))
```

```{r compare_pairs, cache=TRUE, autodep=TRUE}
#```{r compare_pairs}

# create a reverse index table of sentences_df to fast index into sentences_df 
#   given a sentences_df$id 
sntnc_pos_df <- data.frame(pos=rep(-1, max(sentences_df$id)),
                           id=seq(1, max(sentences_df$id)))
for (row_pos in seq(1:nrow(sentences_df))) {
    sntnc_pos_df[sentences_df[row_pos, "id"], "pos"] <- row_pos
}
myprint_df(sntnc_pos_df)

sentence_edit_distance <- function(words_lst1, words_lst2) {
#     words1 <- sort(unlist(words_lst1))
#     words2 <- sort(unlist(words_lst2))
    words1 <- unlist(words_lst1)
    words2 <- unlist(words_lst2)
    
    distance <- length(union(words1, words2)) - length(intersect(words1, words2))
    # account for substitutions
    if ((distance == 2) & (length(words1) == length(words2)))
        distance <- 1
    return(distance)
}

loop_step_id_set <- c(  "1_comparison_pairs_df_access"
                      , "2_sentences_df_access"
                      , "3_update_edit_distance"
                     )
loop_df <- data.frame(loop_step_id=loop_step_id_set)
loop_df[, names(summary(proc.time()))] <- 
    rep(0, length(names(summary(proc.time()))) * nrow(loop_df)) 

for (loop_step_id in loop_df$loop_step_id) {
#for (loop_step_id in loop_df[nrow(loop_df), "loop_step_id"]) {   
    ptm <- proc.time()
    ptm_diff <- proc.time() - ptm
    
    for (row in seq(1, nrow(comparison_pairs_df))) {
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[1])) {
            row_id1 <- comparison_pairs_df[row, "query_id"]
            row_id2 <- comparison_pairs_df[row, "compare_id"]
        }
                
        if (toString(loop_step_id) >= toString(loop_step_id_set[2])) {
#             row_words_lst1 <- sentences_df[sentences_df$id == row_id1, "words_lst"]
#             row_words_lst2 <- sentences_df[sentences_df$id == row_id2, "words_lst"]
            row_words_lst1 <- sentences_df[sntnc_pos_df[row_id1, "pos"], "words_lst"]
            row_words_lst2 <- sentences_df[sntnc_pos_df[row_id2, "pos"], "words_lst"]
        }
        
        if (toString(loop_step_id) >= toString(loop_step_id_set[3])) {
            comparison_pairs_df[row, "edit_distance"] <- 
                sentence_edit_distance(row_words_lst1, row_words_lst2)
        }
    }
    
    ptm_diff <- proc.time() - ptm
    loop_df[loop_df$loop_step_id == loop_step_id, 
                       names(summary(ptm_diff))] <- summary(ptm_diff)
}
loop_steps_plot_df <- melt(loop_df, id="loop_step_id", 
                           measure=c("user", "system", "elapsed"))
p <- ggplot(data=loop_steps_plot_df, mapping=aes(x=loop_step_id, y=value)) + 
        geom_line(aes(group=variable, color=variable)) 
print(p)
loop_df$user_diff <- sapply(seq(1, nrow(loop_df)), 
                            function(step) ifelse(step <= 1, 0,
                            loop_df[step, "user"] - loop_df[step - 1, "user"]))
print(loop_df)

print(all.equal(comparison_pairs_df, 
                comparison_pairs_old_df))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="compare_pairs", 
                                   elapsed=stm_diff["elapsed"]))
```

```{r inspect_results, cache=TRUE, autodep=TRUE}
zero_edit_distance_row <- 
    comparison_pairs_df[which(comparison_pairs_df$edit_distance == 
                              0)[1], ]
print(zero_edit_distance_row)
print(paste0("edit_distance==0: ", toString(zero_edit_distance_row)))
if (!is.na(zero_edit_distance_row$query_id)) {
    print(sentences_df[sentences_df$id == zero_edit_distance_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == zero_edit_distance_row$compare_id, "words_lst"])
}

one_edit_distance_rows <- 
    comparison_pairs_df[which(comparison_pairs_df$edit_distance == 
                              1), ]
one_edit_distance_rows <- merge(one_edit_distance_rows, 
                                sentences_df[, c("id", "words_n")], 
                                by.x="query_id", by.y="id")
names(one_edit_distance_rows)[4] <- "query_words_n"
one_edit_distance_rows <- merge(one_edit_distance_rows, 
                                sentences_df[, c("id", "words_n")], 
                                by.x="compare_id", by.y="id")
names(one_edit_distance_rows)[5] <- "compare_words_n"
one_edit_distance_ad_row <- subset(one_edit_distance_rows, 
                                   query_words_n != compare_words_n)[1, ]
print(paste0("edit_distance==1(A/D): ", toString(one_edit_distance_ad_row)))
if (!is.na(one_edit_distance_ad_row$query_id)) {
    print(sentences_df[sentences_df$id == one_edit_distance_ad_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == one_edit_distance_ad_row$compare_id, "words_lst"])
    query_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_ad_row$query_id, 
                            "words_lst"])
    compare_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_ad_row$compare_id, 
                            "words_lst"])
    print(setdiff(union(query_words_lst, compare_words_lst), 
                  intersect(query_words_lst, compare_words_lst)))
}

one_edit_distance_md_row <- subset(one_edit_distance_rows, 
                                   query_words_n == compare_words_n)[1, ]
print(paste0("edit_distance==1(Mod): ", toString(one_edit_distance_md_row)))
if (!is.na(one_edit_distance_md_row$query_id)) {
    print(sentences_df[sentences_df$id == one_edit_distance_md_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == one_edit_distance_md_row$compare_id, "words_lst"])
    query_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_md_row$query_id, 
                            "words_lst"])
    compare_words_lst <- 
        unlist(sentences_df[sentences_df$id == one_edit_distance_md_row$compare_id, 
                            "words_lst"])
    print(setdiff(union(query_words_lst, compare_words_lst), 
                  intersect(query_words_lst, compare_words_lst)))
}

two_edit_distance_row <- 
    comparison_pairs_df[which(comparison_pairs_df$edit_distance == 
                              2)[1], ]
print(paste0("edit_distance==2: ", toString(two_edit_distance_row)))
if (!is.na(two_edit_distance_row$query_id)) {
    print(sentences_df[sentences_df$id == two_edit_distance_row$query_id, "words_lst"])
    print(sentences_df[sentences_df$id == two_edit_distance_row$compare_id, "words_lst"])
    query_words_lst <- 
        unlist(sentences_df[sentences_df$id == two_edit_distance_row$query_id, 
                            "words_lst"])
    compare_words_lst <- 
        unlist(sentences_df[sentences_df$id == two_edit_distance_row$compare_id, 
                            "words_lst"])
    print(setdiff(union(query_words_lst, compare_words_lst), 
                  intersect(query_words_lst, compare_words_lst)))
}

print(sprintf("Script Summary:"))
print(sprintf("Number of sentences read:%s", 
              format(nrow(sentences_df), big.mark=',')))
print(sprintf("Number of sentences identified for comparison:%s", 
              format(nrow(comparison_pairs_df), big.mark=',')))
print(sprintf("Comparison density: %0.4f", 
              nrow(comparison_pairs_df) / (nrow(sentences_df) ^ 2)))
print(sprintf("Number of sentence pairs within edit distance of 1: %s",
              format(sum(comparison_pairs_df$edit_distance <= 1), big.mark=',')))

stm_diff <- proc.time() - stm
script_time_df <- rbind(script_time_df, 
                        data.frame(chunk="inspect_results", 
                                   elapsed=stm_diff["elapsed"]))
```

```{r print_sessionInfo, echo=FALSE}
rownames(script_time_df) <- seq(1, nrow(script_time_df))
script_time_df$elapsed_diff <- sapply(seq(1, nrow(script_time_df)), 
                                      function(step) ifelse(step <= 1, 0,
        script_time_df[step, "elapsed"] - script_time_df[step - 1, "elapsed"]))
print(script_time_df[order(script_time_df$elapsed_diff, decreasing=TRUE),])
print(sprintf("Total Elapsed Time: %s secs", 
              format(script_time_df[nrow(script_time_df), "elapsed"], big.mark=',')))
sessionInfo()
```